apiVersion: v1
kind: Service
metadata:
  name: api
  labels:
    app: api
spec:
  ports:
  - name: http
    port: 5000    
    targetPort: 5000
  selector:
    app: api
  type: LoadBalancer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
  labels:
    app: api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      containers:
      - name: api
        image: docker.io/itp22103/app-image:v1.0
        env:
        - name: FLASK_APP
          value: "app.py"
        #### Keycloak Related vars ####
        - name: KEYCLOAK_URI
          value: http://192.168.49.2:32301
        - name: ADMIN_REALM
          value: master
        - name: ADMIN_CLIENT_ID
          value: admin-cli
        - name: REALM
          value: DIT189
        - name: CLIENT_ID
          value: DIT189-Backend-Client
        - name: CLIENT_SECRET
          value: WpsxYA8Vq0GTSG9xeUK44tuBXfwAD76m
        - name: KEYCLOACK_ADMIN
          value: admin
        - name: KEYCLOACK_PASSWORD
          value: admin
        #### Database Related vars ####
        - name: POSTGRES_HOST	
          value: api-db
        - name: API_DB
          value: api-db
        - name: DATABASE_USER
          value: postgres
        - name: DATABASE_PASSWORD
          value: postgres
        - name: DEV_DATABASE_URL
          value: postgresql://postgres:postgres@api-db/api-db
        ports:
        - containerPort: 5000
        readinessProbe:
          httpGet:
            path: /ready
            port: 5000
          initialDelaySeconds: 15
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /alive
            port: 5000
          initialDelaySeconds: 20
          periodSeconds: 5
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api
  namespace: default
spec:
  ingressClassName: nginx
  rules:
    - host: dev.k8s
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: api
                port:
                  number: 444